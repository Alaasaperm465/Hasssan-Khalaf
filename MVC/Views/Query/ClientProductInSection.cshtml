@model MVC.Controllers.ClientProductSectionViewModel
@{
    ViewData["Title"] = "عميل+منتج في قسم";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="container mt-3">
    <h3>مخزون عميل لمنتج داخل قسم</h3>

    <form method="post" class="row g-2 align-items-end" id="filterForm" onsubmit="return false;">
        <div class="col-auto">
            <label class="form-label">القسم</label>
            <select id="sectionSelect" name="sectionId" class="form-select">
                <option value="">-- اختر القسم --</option>
                @foreach(Microsoft.AspNetCore.Mvc.Rendering.SelectListItem s in ViewBag.Sections)
                {
                    <option value="@s.Value">@s.Text</option>
                }
            </select>
        </div>
        <div class="col-auto">
            <label class="form-label">العميل</label>
            <select id="clientSelect" name="clientId" class="form-select">
                <option value="">-- اختر العميل --</option>
                @foreach(Microsoft.AspNetCore.Mvc.Rendering.SelectListItem c in ViewBag.Clients)
                {
                    <option value="@c.Value">@c.Text</option>
                }
            </select>
        </div>
        <div class="col-auto">
            <label class="form-label">المنتج</label>
            <select id="productSelect" name="productId" class="form-select">
                <option value="">-- اختر المنتج --</option>
                @foreach(Microsoft.AspNetCore.Mvc.Rendering.SelectListItem p in ViewBag.Products)
                {
                    <option value="@p.Value">@p.Text</option>
                }
            </select>
        </div>
    </form>

    <div id="detailContainer" class="mt-3"></div>

    @if (Model != null)
    {
        <div class="card mt-3 p-3">
            <div>SectionId: <strong>@Model.SectionId</strong></div>
            <div>ClientId: <strong>@Model.ClientId</strong></div>
            <div>ProductId: <strong>@Model.ProductId</strong></div>
            <div>Cartons: <strong>@Model.Cartons</strong></div>
            <div>Pallets: <strong>@Model.Pallets</strong></div>
        </div>
    }
</div>

@section Scripts {
    <script>
        (function(){
            const sectionSelect = document.getElementById('sectionSelect');
            const clientSelect = document.getElementById('clientSelect');
            const productSelect = document.getElementById('productSelect');
            const detailContainer = document.getElementById('detailContainer');

            async function loadDetails() {
                const sectionId = sectionSelect.value;
                const clientId = clientSelect.value;
                const productId = productSelect.value;
                detailContainer.innerHTML = '';
                if (!sectionId || !clientId || !productId) return;

                try {
                    const resp = await fetch(`/Query/SectionDetails?sectionId=${encodeURIComponent(sectionId)}`);
                    if (!resp.ok) throw new Error('Failed to load');
                    const data = await resp.json();

                    // data is { clients: [...], totals: {...} }
                    const clients = data.clients || data.Clients || [];

                    const client = clients.find(c => c.clientId === parseInt(clientId, 10));
                    if (!client) {
                        detailContainer.innerHTML = '<div class="text-muted">لا توجد بيانات لهذا العميل في هذا القسم.</div>';
                        return;
                    }

                    const prod = (client.products || client.Products || []).find(p => p.productId === parseInt(productId, 10));
                    if (!prod) {
                        detailContainer.innerHTML = '<div class="text-muted">لا توجد بيانات لهذا المنتج للعميل المحدد في هذا القسم.</div>';
                        return;
                    }

                    let html = `
                        <div class="card shadow-sm p-3">
                            <div class="mb-2"><strong>العميل:</strong> ${escapeHtml(client.clientName || client.clientName || '')} </div>
                            <div class="mb-2"><strong>المنتج:</strong> ${escapeHtml(prod.productName || prod.productName || '')} </div>
                            <div class="mb-2"><strong>كرتون:</strong> ${prod.cartons} </div>
                            <div class="mb-2"><strong>بالت:</strong> ${prod.pallets}</div>
                        </div>
                    `;

                    detailContainer.innerHTML = html;
                } catch (e) {
                    console.error(e);
                    detailContainer.innerHTML = '<div class="text-danger">فشل تحميل البيانات.</div>';
                }
            }

            function escapeHtml(str){
                if(!str) return '';
                return str.replace(/[&<>"']/g, function(m){return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m];});
            }

            sectionSelect.addEventListener('change', loadDetails);
            clientSelect.addEventListener('change', loadDetails);
            productSelect.addEventListener('change', loadDetails);

            (function(){
                const modelSection = '@(Model?.SectionId ?? 0)';
                const modelClient = '@(Model?.ClientId ?? 0)';
                const modelProduct = '@(Model?.ProductId ?? 0)';
                if (modelSection && modelClient && modelProduct && modelSection !== '0' && modelClient !== '0' && modelProduct !== '0') {
                    sectionSelect.value = modelSection;
                    clientSelect.value = modelClient;
                    productSelect.value = modelProduct;
                    loadDetails();
                }
            })();
        })();
    </script>
}
