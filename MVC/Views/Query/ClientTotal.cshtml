@model MVC.Controllers.ClientTotalDTO
@{
}
<div class="container mt-3">
    <h3>إجمالي المخزون لعميل</h3>

    <form method="get" class="row g-2 align-items-end" onsubmit="return false;">
        <div class="col-auto">
            <label class="form-label">العميل</label>
            <select id="clientSelect" name="clientId" class="form-select">
                <option value="">-- اختر العميل --</option>
                @foreach(Microsoft.AspNetCore.Mvc.Rendering.SelectListItem c in ViewBag.Clients)
                {
                    <option value="@c.Value">@c.Text</option>
                }
            </select>
        </div>
        <div class="col-auto d-flex gap-2 align-items-end">
            <a id="exportCsvBtn" class="btn btn-outline-secondary" style="display:none;" href="#">تصدير CSV</a>
        </div>
    </form>

    <div id="detailContainer" class="mt-3"></div>

    @if (Model != null)
    {
        <div class="card mt-3 p-3">
            <div>ClientId: <strong>@Model.ClientId</strong></div>
            <div>ClientName: <strong>@Model.ClientName</strong></div>
            <div>Total Cartons: <strong>@Model.TotalCartons</strong></div>
            <div>Total Pallets: <strong>@Model.TotalPallets</strong></div>
        </div>
    }
</div>

@section Scripts {
    <script>
        (function(){
            const clientSelect = document.getElementById('clientSelect');
            const detailContainer = document.getElementById('detailContainer');
            const exportCsvBtn = document.getElementById('exportCsvBtn');

            function renderError(msg){ detailContainer.innerHTML = `<div class="text-danger">${msg}</div>`; }
            function renderEmpty(){ detailContainer.innerHTML = '<div class="text-muted">لا توجد بيانات لهذا العميل.</div>'; }
            function renderLoading(){ detailContainer.innerHTML = '<div class="text-muted">جاري التحميل... <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span></div>'; }

            async function loadClientDetails(clientId){
                if(!clientId){ detailContainer.innerHTML = ''; exportCsvBtn.style.display = 'none'; return; }
                renderLoading();
                try{
                    // call section details for all sections to aggregate per client
                    const url = '@Url.Action("SectionDetails","Query")' + '?sectionId=';
                    // fetch sections list
                    const sectionsResp = await fetch('@Url.Action("SectionTotal","Query")');
                    // we don't have a JSON sections endpoint; instead build sections from select element in other pages
                    // For now: request all sections via API controller if exists

                    // naive approach: iterate known sections from ViewBag if present
                    const sectionOptions = Array.from(document.querySelectorAll('select[name="sectionId"] option')).filter(o=>o.value).map(o=>o.value);

                    // if no sections in DOM, attempt to fetch /api/sections
                    let sections = sectionOptions;
                    if (sections.length === 0){
                        try{
                            const apiResp = await fetch('/api/Sections');
                            if(apiResp.ok){
                                const arr = await apiResp.json();
                                sections = arr.map(s => s.id);
                            }
                        }catch(e){/* ignore */}
                    }

                    if (sections.length === 0){ renderError('لا توجد أقسام متاحة'); return; }

                    const clientsAggregate = {};
                    for (const sid of sections){
                        const resp = await fetch('@Url.Action("SectionDetails","Query")' + '?sectionId=' + encodeURIComponent(sid), { credentials: 'same-origin' });
                        if(!resp.ok) continue;
                        const payload = await resp.json();
                        const clients = Array.isArray(payload) ? payload : (payload.clients || []);
                        for (const c of clients){
                            if (c.clientId !== parseInt(clientId, 10)) continue;
                            // add totals
                            if(!clientsAggregate[c.clientId]) clientsAggregate[c.clientId] = { clientName: c.clientName, totalCartons: 0, totalPallets: 0, products: [] };
                            clientsAggregate[c.clientId].totalCartons += c.totalCartons || 0;
                            clientsAggregate[c.clientId].totalPallets += c.totalPallets || 0;
                            (c.products || []).forEach(p => clientsAggregate[c.clientId].products.push({ productId: p.productId, productName: p.productName, cartons: p.cartons, pallets: p.pallets }));
                        }
                    }

                    const agg = clientsAggregate[parseInt(clientId,10)];
                    if(!agg){ renderEmpty(); return; }

                    exportCsvBtn.style.display = 'inline-block';
                    exportCsvBtn.href = '@Url.Action("ClientTotalCsv","Query")' + '?clientId=' + encodeURIComponent(clientId);

                    let html = '<div class="card p-3 shadow-sm">';
                    html += `<h5>تفصيل مجمع للعميل: ${escapeHtml(agg.clientName)}</h5>`;
                    html += `<div class="text-muted mb-2">المجموع: <strong>${agg.totalCartons}</strong> كرتون — <strong>${agg.totalPallets}</strong> بالت</div>`;
                    html += '<div class="table-responsive"><table class="table table-striped"><thead><tr><th>المنتج</th><th class="text-end">كرتون</th><th class="text-end">بالت</th></tr></thead><tbody>';
                    // aggregate products by productId
                    const prodMap = {};
                    agg.products.forEach(p=>{
                        if(!prodMap[p.productId]) prodMap[p.productId] = { productName: p.productName, cartons:0, pallets:0 };
                        prodMap[p.productId].cartons += p.cartons || 0;
                        prodMap[p.productId].pallets += p.pallets || 0;
                    });
                    Object.keys(prodMap).forEach(pid=>{
                        const p = prodMap[pid];
                        html += `<tr><td>${escapeHtml(p.productName)}</td><td class="text-end">${p.cartons}</td><td class="text-end">${p.pallets}</td></tr>`;
                    });
                    html += '</tbody></table></div></div>';

                    detailContainer.innerHTML = html;
                }catch(err){ console.error(err); renderError('فشل تحميل البيانات. ' + (err && err.message ? err.message : '')); exportCsvBtn.style.display = 'none'; }
            }
            function escapeHtml(str){ if(!str) return ''; return String(str).replace(/[&<>"']/g, function(m){return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m];}); }

            clientSelect.addEventListener('change', function(){ loadClientDetails(this.value); });

            document.addEventListener('DOMContentLoaded', function(){ const val = clientSelect.value; if(val){ loadClientDetails(val); } });
        })();
    </script>
}
