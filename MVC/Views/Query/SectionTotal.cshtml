@model MVC.Controllers.SectionStockDTO
@{
    ViewData["Title"] = "مجموع قسم";
    Layout = "~/Views/Shared/_Layout.cshtml";
}
<div class="container mt-3">
    <h3>مجموع المخزون في قسم</h3>

    <form method="get" class="row g-2 align-items-end" onsubmit="return false;">
        <div class="col-auto">
            <label class="form-label">القسم</label>
            <select id="sectionSelect" name="sectionId" class="form-select">
                <option value="">-- اختر القسم --</option>
                @foreach(Microsoft.AspNetCore.Mvc.Rendering.SelectListItem s in ViewBag.Sections)
                {
                    <option value="@s.Value">@s.Text</option>
                }
            </select>
        </div>
        <div class="col-auto d-flex gap-2 align-items-end">
            <a id="exportCsvBtn" class="btn btn-outline-secondary" style="display:none;" href="#">تصدير CSV</a>
            <!-- kept for compatibility but not required to click -->
            <button type="submit" class="btn btn-primary" style="display:none;">نفّذ الأكشن</button>
        </div>
    </form>

    <div id="detailContainer" class="mt-3"></div>

    @if (Model != null)
    {
        <div class="card mt-3 p-3">
            <div>SectionId: <strong>@Model.SectionId</strong></div>
            <div>Total Cartons: <strong>@Model.TotalCartons</strong></div>
            <div>Total Pallets: <strong>@Model.TotalPallets</strong></div>
        </div>
    }
</div>

@section Scripts {
    <script>
        (function(){
            const sectionSelect = document.getElementById('sectionSelect');
            const detailContainer = document.getElementById('detailContainer');
            const exportCsvBtn = document.getElementById('exportCsvBtn');

            function renderError(msg){
                detailContainer.innerHTML = `<div class="text-danger">${msg}</div>`;
            }

            function renderEmpty(){
                detailContainer.innerHTML = '<div class="text-muted">لا توجد بيانات لهذا القسم.</div>';
            }

            function renderLoading(){
                detailContainer.innerHTML = '<div class="text-muted">جاري التحميل... <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span></div>';
            }

            async function loadDetails(sectionId){
                if(!sectionId){ detailContainer.innerHTML = ''; exportCsvBtn.style.display = 'none'; return; }
                renderLoading();
                try{
                    const url = '@Url.Action("SectionDetails", "Query")' + '?sectionId=' + encodeURIComponent(sectionId);
                    const resp = await fetch(url, { credentials: 'same-origin' });
                    const ct = resp.headers.get('content-type') || '';
                    if(!resp.ok || ct.indexOf('application/json') === -1){
                        if(resp.url && resp.url.toLowerCase().includes('/account/login')){ window.location.href = resp.url; return; }
                        throw new Error('الاستجابة من الخادم غير متوقعة');
                    }
                    const payload = await resp.json();

                    // support both old array response and new { clients, totals }
                    let clients = [];
                    let totals = { totalCartons: 0, totalPallets: 0 };
                    if (Array.isArray(payload)) {
                        clients = payload;
                        totals.totalCartons = clients.reduce((s,c)=> s + (c.totalCartons||0), 0);
                        totals.totalPallets = clients.reduce((s,c)=> s + (c.totalPallets||0), 0);
                    } else if (payload && payload.clients) {
                        clients = payload.clients;
                        totals = payload.totals || totals;
                    }

                    if(!Array.isArray(clients) || clients.length === 0){ renderEmpty(); exportCsvBtn.style.display = 'none'; return; }

                    // show export link
                    exportCsvBtn.style.display = 'inline-block';
                    exportCsvBtn.href = '@Url.Action("SectionDetailsCsv","Query")' + '?sectionId=' + encodeURIComponent(sectionId);

                    // build HTML summary
                    let html = '<div class="card p-3 shadow-sm">';
                    html += '<div class="d-flex justify-content-between align-items-center mb-2">';
                    html += '<h5 class="mb-0">تفصيل حسب العميل</h5>';
                    html += `<div class="text-muted">المجموع: <strong>${totals.totalCartons}</strong> كرتون — <strong>${totals.totalPallets}</strong> بالت</div>`;
                    html += '</div>';
                    html += '<div class="table-responsive"><table class="table table-striped"><thead><tr><th>العميل</th><th class="text-end">كرتون</th><th class="text-end">بالت</th></tr></thead><tbody>';
                    clients.forEach(client =>{
                        html += `<tr><td>${escapeHtml(client.clientName)}</td><td class="text-end">${client.totalCartons}</td><td class="text-end">${client.totalPallets}</td></tr>`;
                        // products
                        html += '<tr><td colspan="3">';
                        html += '<div class="table-responsive"><table class="table mb-0"><thead><tr><th>المنتج</th><th class="text-end">كرتون</th><th class="text-end">بالت</th></tr></thead><tbody>';
                        (client.products||[]).forEach(p=>{
                            html += `<tr><td>${escapeHtml(p.productName)}</td><td class="text-end">${p.cartons}</td><td class="text-end">${p.pallets}</td></tr>`;
                        });
                        html += '</tbody></table></div>';
                        html += '</td></tr>';
                    });
                    html += '</tbody></table></div></div>';

                    detailContainer.innerHTML = html;
                }catch(err){
                    console.error(err);
                    renderError('فشل تحميل البيانات. ' + (err && err.message ? err.message : ''));
                    exportCsvBtn.style.display = 'none';
                }
            }

            function escapeHtml(str){
                if(!str) return '';
                return String(str).replace(/[&<>"']/g, function(m){return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m];});
            }

            // load when selection changes
            sectionSelect.addEventListener('change', function(){ loadDetails(this.value); });

            // on page load: if there's a selected value, or only one real option, load automatically
            document.addEventListener('DOMContentLoaded', function(){
                const val = sectionSelect.value;
                if(val){ loadDetails(val); return; }
                const opts = Array.from(sectionSelect.options).filter(o=>o.value);
                if(opts.length === 1){ sectionSelect.value = opts[0].value; loadDetails(opts[0].value); }
            });
        })();
    </script>
}

