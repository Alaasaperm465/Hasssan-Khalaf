@model MVC.ViewModels.Outbound.OutboundCreateVM
@{
    ViewData["Title"] = "Create Outbound";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid mt-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h5 mb-0">الصادرات</h2>
        <div>
            <a class="btn btn-secondary" asp-action="Index">عودة</a>
        </div>
    </div>

    <form asp-action="Create" method="post" id="outboundForm">
        @Html.AntiForgeryToken()

        <div class="row g-3 mb-3">
            <div class="col-12 col-md-4">
                <label asp-for="ClientId" class="form-label">العميل</label>
                <select asp-for="ClientId" id="clientSelect" class="form-select" asp-items="Model.Clients">
                    <option value="">-- اختر العميل --</option>
                </select>
                <span asp-validation-for="ClientId" class="text-danger"></span>
            </div>

            <div class="col-12 col-md-4">
                <label asp-for="DelegateId" class="form-label">المفوض</label>
                <select asp-for="DelegateId" id="delegateSelect" class="form-select" asp-items="Model.Delegates">
                    <option value="">-- اختر المفوض --</option>
                </select>
                <span asp-validation-for="DelegateId" class="text-danger"></span>
            </div>

            <div class="col-12 col-md-4">
                <label asp-for="SectionId" class="form-label">العنبر (تطبيق على السطور)</label>
                <select asp-for="SectionId" id="topSectionSelect" class="form-select" asp-items="Model.Sections">
                    <option value="">-- لا شيء --</option>
                </select>
            </div>
        </div>

        <h5 class="mt-3 mb-2">Lines</h5>
        <div class="card mb-3">
            <div class="card-body p-2 p-sm-3">
                <div class="table-responsive">
                    <table class="table table-sm table-bordered mb-0" id="linesTable">
                        <thead class="table-light">
                            <tr>
                                <th class="w-35">المنتج</th>
                                <th class="w-10">الكرتون</th>
                                <th class="w-10">بالتات</th>
                                <th class="w-10">العمليات</th>
                            </tr>
                        </thead>
                        <tbody>
                            @for (int i = 0; i < Model.Details.Count; i++)
                            {
                                <tr>
                                    <td>
                                        <select name="Details[@i].ProductId" class="form-select line-input">
                                            <option value="">-- اختر المنتج --</option>
                                            @foreach (var p in Model.Products)
                                            {
                                                if (p.Value == Model.Details[i].ProductId.ToString())
                                                {
                                                    <option value="@p.Value" selected>@p.Text</option>
                                                }
                                                else
                                                {
                                                    <option value="@p.Value">@p.Text</option>
                                                }
                                            }
                                        </select>
                                    </td>
                                    <td>
                                        <input type="number" name="Details[@i].Cartons" class="form-control line-input" value="@Model.Details[i].Cartons" min="0" />
                                    </td>
                                    <td>
                                        <input type="number" name="Details[@i].Pallets" class="form-control line-input" value="@Model.Details[i].Pallets" min="0" />
                                    </td>
                                    <td class="text-center">
                                        <button type="button" class="btn btn-sm btn-danger remove-line">حذف</button>
                                    </td>
                                    <input type="hidden" name="Details[@i].SectionId" value="@(Model.SectionId ?? 0)" class="line-section-hidden" />
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <div class="mt-2 d-flex gap-2">
                    <button type="button" id="addLine" class="btn btn-sm btn-outline-secondary">إضافة سطر (أو Enter)</button>
                    <div class="text-muted small">اضغط Enter في آخر خانة لإضافة السطر التالي والانتقال إليه</div>
                </div>
            </div>
        </div>

        <div class="d-flex justify-content-between align-items-center mb-3">
            <div>
                <strong>Totals:</strong> Cartons: <span id="totalCartons">0</span> &nbsp; Pallets: <span id="totalPallets">0</span>
            </div>
            <div class="d-none d-sm-block">
                <button type="submit" class="btn btn-primary">حفظ الإذن</button>
            </div>
        </div>

        <div class="d-block d-sm-none mt-3">
            <button type="submit" class="btn btn-primary w-100">حفظ الإذن</button>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        (function() {
            const products = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Products.Select(p => new { value = p.Value, text = p.Text, type = p.Value })));
            const sections = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Sections.Select(s => new { value = s.Value, text = s.Text })));
            
            const clientSelect = document.querySelector('[name="ClientId"]');
            const delegateSelect = document.getElementById('delegateSelect');
            const topSectionSelect = document.getElementById('topSectionSelect');
            const tbody = document.querySelector('#linesTable tbody');
            
            let allowedTypes = null;
            let pairs = [];

            function recalcTotals() {
                let cartons = 0, pallets = 0;
                document.querySelectorAll('#linesTable tbody tr').forEach(row => {
                    const cEl = row.querySelector('input[name$=".Cartons"]');
                    const pEl = row.querySelector('input[name$=".Pallets"]');
                    const c = cEl ? parseInt(cEl.value || '0') : 0;
                    const p = pEl ? parseInt(pEl.value || '0') : 0;
                    cartons += isNaN(c) ? 0 : c;
                    pallets += isNaN(p) ? 0 : p;
                });
                document.getElementById('totalCartons').innerText = cartons;
                document.getElementById('totalPallets').innerText = pallets;
            }

            function productOptionsForClientAndSection() {
                let list = (allowedTypes && allowedTypes.length > 0) ? products.filter(p => allowedTypes.includes(parseInt(p.type))) : products;
                const selectedSection = topSectionSelect && topSectionSelect.value ? String(topSectionSelect.value) : null;
                if (selectedSection) {
                    const allowedProductIds = pairs.filter(p => String(p.sectionId) === String(selectedSection)).map(p => String(p.productId));
                    if (allowedProductIds.length > 0) list = list.filter(p => allowedProductIds.includes(String(p.value)));
                }
                return '<option value="">-- اختر المنتج --</option>' + list.map(p => `<option value="${p.value}">${p.text}</option>`).join('');
            }

            function setDelegateOptions(list) {
                const html = '<option value="">-- اختر المفوض --</option>' + (list || []).map(d => `<option value="${d.value}">${d.text}</option>`).join('');
                if (delegateSelect) delegateSelect.innerHTML = html;
            }

            function addLine() {
                const index = tbody.children.length;
                const tr = document.createElement('tr');
                tr.innerHTML = `\
                    <td>\
                        <select name="Details[${index}].ProductId" class="form-select line-input">\
//+                        ${productOptionsForClientAndSection()}\
+                        ${productOptionsForClientAndSection()}\
                        </select>\
                    </td>\
                    <td><input type="number" name="Details[${index}].Cartons" class="form-control line-input" value="0" min="0" /></td>\
                    <td><input type="number" name="Details[${index}].Pallets" class="form-control line-input" value="0" min="0" /></td>\
                    <td class="text-center"><button type="button" class="btn btn-sm btn-danger remove-line">حذف</button></td>\
                    <input type="hidden" name="Details[${index}].SectionId" value="${topSectionSelect ? topSectionSelect.value : 0}" class="line-section-hidden" />\
                `;
                tbody.appendChild(tr);
                attachRowEvents(tr);
                recalcTotals();
            }
            
            function attachRowEvents(tr) {
                const inputs = Array.from(tr.querySelectorAll('.line-input'));
                inputs.forEach((inp, idx) => {
                    inp.addEventListener('input', recalcTotals);
                    inp.addEventListener('keydown', function(ev) {
                        if (ev.key === 'Enter') {
                            ev.preventDefault();
                            if (idx < inputs.length - 1) { inputs[idx+1].focus(); return; }
                            addLine();
                        }
                    });
                });

                tr.querySelector('.remove-line').addEventListener('click', function() {
                    tr.remove();
                    document.querySelectorAll('#linesTable tbody tr').forEach((r,i) => {
                        r.querySelectorAll('select, input[type="number"]').forEach(el => {
                            const name = el.getAttribute('name'); if (!name) return;
                            el.setAttribute('name', name.replace(/Details\[\d+\]/, `Details[${i}]`));
                        });
                        // update hidden section input name
                        const hidden = r.querySelector('.line-section-hidden');
                        if (hidden) hidden.setAttribute('name', hidden.getAttribute('name').replace(/Details\[\d+\]/, `Details[${i}]`));
                    });
                    recalcTotals();
                });
            }

            clientSelect.addEventListener('change', function() {
                const clientId = this.value;
                if (!clientId) { allowedTypes = null; pairs = []; setDelegateOptions([]); document.querySelectorAll('select[name$=".ProductId"]').forEach(s => s.innerHTML = '<option value="">-- اختر المنتج --</option>'); return; }

                fetch(`/Clients/GetAllowedProductTypes?clientId=${clientId}`)
                    .then(r => r.json()).then(d => { allowedTypes = (d && d.types) ? d.types.map(t => parseInt(t)) : null; })
                    .catch(()=> allowedTypes = null)
                    .finally(() => {
                        fetch(`/Stock/GetClientStocks?clientId=${clientId}`)
                            .then(r => r.json())
                            .then(data => {
                                pairs = data.pairs || [];
                                document.querySelectorAll('select[name$=".ProductId"]').forEach(sel => sel.innerHTML = productOptionsForClientAndSection());

                                fetch(`/Outbound/GetDelegatesForClient?clientId=${clientId}`)
                                    .then(r => r.json())
                                    .then(list => setDelegateOptions(list))
                                    .catch(()=> setDelegateOptions([]));

                                // populate topSectionSelect with only sections that have pairs for this client
                                const allowedSectionIds = Array.from(new Set(pairs.map(p => String(p.sectionId))));
                                if (allowedSectionIds.length > 0) {
                                    const opts = ['<option value="">-- لا شيء --</option>'].concat(sections.filter(s => allowedSectionIds.includes(String(s.value))).map(s => `<option value="${s.value}">${s.text}</option>`));
                                    topSectionSelect.innerHTML = opts.join('');
                                } else {
                                    // fallback: show all sections
                                    topSectionSelect.innerHTML = '<option value="">-- لا شيء --</option>' + sections.map(s => `<option value="${s.value}">${s.text}</option>`).join('');
                                }
                            })
                            .catch(()=> {});
                    });
            });

            topSectionSelect.addEventListener('change', function() {
                document.querySelectorAll('select[name$=".ProductId"]').forEach(sel => sel.innerHTML = productOptionsForClientAndSection());
                // update all hidden section inputs
                document.querySelectorAll('.line-section-hidden').forEach(h => h.value = topSectionSelect.value || 0);
            });

            document.getElementById('addLine').addEventListener('click', addLine);
            document.querySelectorAll('#linesTable tbody tr').forEach(tr => attachRowEvents(tr));
            recalcTotals();

            if (clientSelect && clientSelect.value) clientSelect.dispatchEvent(new Event('change'));
        })();
    </script>
}
